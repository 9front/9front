#!/bin/rc
if(! bind -a '#u' /dev)
	exit

mkdir -p -m 700 '#σc/usb'
mkdir -p -m 700 '#σc/usbnet'

if(! nusb/usbd)
	exit

@{
	rfork ne
	fn attach {
		switch($4){
		case *03
			nusb/kb $1 &
		case *02
			nusb/ether $1 &
		case *08
			@{
				rfork ne
				nusb/disk $1
				cd '#σ/usb'
				for(dev in sdU^$1.*) if(test -d $dev) {
					diskparts $dev
					for(part in $dev/dos* $dev/9fat) if(test -r $part) {
						mkdir -m 0700 '#σc/'^$dev || exit
						{dossrv -s -f $part &} <[0=1] |
							echo 0 >'#σc/'^$dev/dos
						exit
					}
				}
			} &
		case *
			if(~ $2 0424 && ~ $3 ec00){
				# raspberry pi ethernet
				nusb/ether $1 &
			}
		}
	}
	fn detach {
		rm -rf '#σc/usb/'^$1.* '#σc/sdU'^$1.* '#σc/usbnet/'^$1.*
	}
	rc < '#σ/usb/usbevent' &
}

bind -a '#σ/usb' /dev
bind -a '#σ/usbnet' /net
